![[Pasted image 20251216213511.png]]
### 知识点一：数据冲突的静态调度（调整指令顺序）

**考点解读：**
静态调度是指编译器在生成代码时，通过重新排列指令的顺序（Reordering），在保持程序逻辑不变的前提下，将不相关的指令插入到由于数据相关（如写后读 RAW）导致的停顿（Stall）空隙中，从而减少流水线的停顿周期，提高效率。

#### 【习题 1】
假设某计算机采用标准的 5 段流水线（IF, ID, EX, MEM, WB）。
1.  **假设没有采用定向（Forwarding/Bypassing）技术**，只要存在数据相关就需要暂停流水线。
2.  **假设采用了定向技术**，但由于 Load-Use（加载-使用）相关，Load 指令后的第一条指令如果使用了 Load 的结果，仍需停顿 1 个周期。

请针对以下汇编指令序列进行分析：
```assembly
I1: LW  R1, 0(R2)    ; 从内存加载数据到 R1
I2: ADD R3, R1, R4   ; R3 = R1 + R4 (依赖 I1 的 R1)
I3: SUB R5, R6, R7   ; R5 = R6 - R7 (与前两条无关)
I4: OR  R8, R9, R10  ; R8 = R9 | R10 (与前三条无关)
I5: SW  R3, 0(R11)   ; 将 R3 存入内存 (依赖 I2 的 R3)
```

**问题：**
1. 在**有定向技术**的条件下，计算上述指令序列按原顺序执行所需的总时钟周期数（从第一条指令进入 IF 到最后一条指令完成 WB）。
2. 请利用**静态调度**策略调整指令顺序，在保证程序结果正确的前提下消除所有可能的流水线停顿，并写出优化后的指令序列。

#### 【答案与解析】

**1. 原顺序执行的周期分析（有定向）：**
*   标准 5 段流水线执行 $N$ 条指令通常需要 $5 + (N-1)$ 个周期。
*   **分析冲突：**
    *   `I1 (LW)` 和 `I2 (ADD)` 存在 Load-Use 冲突。虽然有定向，但数据在 `I1` 的 MEM 段结束才出来，`I2` 需要在 EX 段开始前得到，中间必须停顿 1 个周期（Stall）。
    *   `I2` 和 `I5` 虽然有数据相关（R3），但 ALU 计算结果（EX段）可以直接定向到 MEM 段之前的输入，不需要停顿。
*   **计算：**
    *   指令数 = 5。
    *   停顿 = 1 (I1 和 I2 之间)。
    *   总周期 = $5 + (5 - 1) + 1 = 10$ 个周期。

**2. 静态调度优化：**
*   **策略：** 寻找与 `I1` 和 `I2` 无关的指令填入 Load-Use 的停顿间隙。
*   **观察：** `I3 (SUB)` 和 `I4 (OR)` 与 `I1`、`I2` 完全独立，互不依赖。
*   **调整：** 将 `I3` 移到 `I1` 和 `I2` 之间。这样 `I1` 执行时，流水线继续执行 `I3`，当 `I3` 处于 ID/EX 阶段时，`I1` 已经完成了 MEM 阶段，数据可以通过定向传给 `I2`，从而消除了停顿。
*   **优化后序列：**
    ```assembly
    LW  R1, 0(R2)
    SUB R5, R6, R7   ; 插入这里，填补 Load 延迟槽
    OR  R8, R9, R10  ; 这一条也可以放这里，或者保持在后面，不影响冲突消除
    ADD R3, R1, R4   ; 此时 R1 数据已准备好
    SW  R3, 0(R11)
    ```
    *(注：将 I3 和 I4 都移到中间也是正确的，甚至只移 I3 就足够消除那个 1 周期的停顿了)*

---

### 知识点二：对于数据通路更深更广的考查

**考点解读：**
这部分可能会考查不仅仅是“连线”，而是考查“为什么要这样连”或者“新增指令需要如何修改数据通路”。“更深”指控制信号的细节（如多路选择器 MUX 的选通逻辑），“更广”指对非标准指令的支持。

#### 【习题 2】
在单周期 MIPS 处理器的数据通路中，我们需要增加一条新的指令 `L_INC Rt, offset(Rs)`。
该指令的功能是：`Rt = Memory[Rs + offset]; Rs = Rs + 1;`（即：加载数据后，自动将基址寄存器加 1）。

**问题：**
1. 现有的标准单周期数据通路（通常只能写回一个寄存器）能否直接支持该指令？为什么？
2. 如果要支持该指令，数据通路中的“寄存器堆（Register File）”的写入端口需要做什么改变？
3. 该指令执行过程中，ALU 应该执行什么运算？

#### 【答案与解析】

**1. 能否支持：**
*   **答案：** 不能。
*   **解析：** 标准 MIPS 单周期数据通路在一个时钟周期内，寄存器堆（Register File）通常只有一个写入数据端口（Write Data）和一个写使能信号（RegWrite）。该指令需要同时完成两个写操作：
    1. 将内存读出的数据写入 `Rt`。
    2. 将 `Rs + 1` 的结果写入 `Rs`。
    发生**结构冲突**，现有硬件资源不足以支持同时写两个不同的寄存器。

**2. 寄存器堆的改变：**
*   **答案：** 需要增加第二个写入端口。
*   **解析：** 寄存器堆需要扩展为：拥有两个写入地址输入（Write Register 1, Write Register 2）、两个写入数据输入（Write Data 1, Write Data 2）以及两个写使能信号。
    *   端口 1 用于写 `Rt`（数据来自 Data Memory）。
    *   端口 2 用于写 `Rs`（数据来自加法器结果）。

**3. ALU 的行为：**
*   **答案：** ALU 需要执行加法运算（Add）。
*   **解析：** 尽管指令包含 `Rs = Rs + 1`，但这是基址寄存器的更新。指令的核心寻址操作是 `Rs + offset`，这需要 ALU 来计算内存地址。
    *   至于 `Rs + 1` 的计算，通常不能复用主 ALU（因为它正忙着算地址），需要一个额外的专用加法器（Adder）或者在多周期/流水线结构中分步完成。在单周期且必须修改硬件的假设下，通常需要额外的加法器来计算 `Rs + 1`。

---

### 知识点三：组合逻辑和微程序两种控制信号生成方式的特点

**考点解读：**
这是计算机组成原理中“控制器（CU）设计”的核心对比。重点在于两者的**设计原理、速度、灵活性**和**适用场景（RISC vs CISC）**。

#### 【习题 3】
某设计团队正在研制一款新型处理器。
*   **方案 A**：控制器采用硬布线（Hardwired / 组合逻辑）方式实现。
*   **方案 B**：控制器采用微程序（Microprogrammed）方式实现。

**问题：**
1. 请在一个表格中对比这两种方式在“运行速度”、“修改指令集的难易程度”和“芯片面积/规整性”三个方面的差异。
2. 如果该处理器是针对**RISC（精简指令集）**架构设计的，追求极致的流水线执行效率，通常应选择哪种方案？为什么？
3. 所谓“微程序控制器”中，机器指令与微指令的关系是什么？

#### 【答案与解析】

**1. 对比表格：**

| 比较维度 | 硬布线控制器 (组合逻辑) | 微程序控制器 (存储逻辑) |
| :--- | :--- | :--- |
| **运行速度** | **快**。控制信号由逻辑门电路直接生成，延迟小。 | **较慢**。需要访问控制存储器（Control Store）读取微指令，有访存延迟。 |
| **修改/扩展难易度** | **难**。修改指令意味着重新布线设计电路，设计复杂。 | **易**。只需修改控制存储器中的微程序（软件/固件），无需改动硬件连线。 |
| **规整性/面积** | 不规整，逻辑复杂，随着指令数增加极其复杂。 | 结构规整（存储器结构），适合复杂指令集。 |

**2. RISC 架构的选择：**
*   **选择：** 方案 A（硬布线/组合逻辑）。
*   **理由：**
    *   RISC 的特点是指令简单、格式固定、寻址方式少。
    *   RISC 的核心目标是**快**，特别是尽量做到单周期执行或流畅的流水线。
    *   硬布线控制器虽然设计复杂，但能提供最快的控制信号生成速度，满足 RISC 高频、高效的要求。微程序的读取延迟会拖慢流水线。

**3. 机器指令与微指令的关系：**
*   **关系：** **1 条机器指令对应 1 段微程序**（由若干条微指令组成的序列）。
*   **解析：**
    *   **机器指令**（如 `ADD R1, R2`）是程序员看到的指令层级。
    *   **微指令**是硬件执行的最小控制步（如“将 PC 内容送上总线”、“ALU 做加法”）。
    *   控制器根据机器指令的操作码（Opcode），找到对应的微程序入口地址，依次执行微指令来完成该机器指令的功能。