#DHCP请求 
  [[计算机网络综合题思考路径]] 
DHCP (Dynamic Host Configuration Protocol, 动态主机配置协议) 是网络管理员的得力助手，它让IP地址管理自动化。

#### 1. #DHCP的核心作用
自动为网络中的设备分配和管理以下信息：
*   **IP地址**
*   **子网掩码**
*   **默认网关地址**
*   **DNS服务器地址**

#### 2. #DHCP工作流程：DORA四步曲

这个过程是面试和考试的绝对高频考点。

*   **D - Discover (发现阶段)**
    *   **触发**: 客户端（如主机2）启动或接入网络，发现自己没有IP地址。
    *   **动作**: 客户端以广播方式发送一个 **DHCP Discover** 报文。
    *   **报文关键信息**:
        *   **源MAC地址**: 客户端自己的MAC地址。
        *   **目的MAC地址**: `ff-ff-ff-ff-ff-ff` (广播)。
        *   **源IP地址**: `0.0.0.0` (表示“我没有IP”)。
        *   **目的IP地址**: `255.255.255.255` (受限广播)。
        *   **传输层**: 使用UDP协议，客户端端口68，服务器端口67。

*   **O - Offer (提供阶段)**
    *   **触发**: 网络中所有收到Discover报文的DHCP服务器。
    *   **动作**: DHCP服务器从自己的地址池中选择一个可用的IP地址，连同其他配置信息，构建一个 **DHCP Offer** 报文，发送给客户端。
    *   **报文关键信息**:
        *   这个报文是**单播**发送的，直接发往客户端的MAC地址。服务器通过Discover报文中的源MAC知道了客户端的“身份”。
        *   报文中包含了预分配的IP地址、租期、网关、DNS等信息。
        *   *注意*：如果网络中有多个DHCP服务器，客户端可能会收到多个Offer。

*   **R - Request (请求阶段)**
    *   **触发**: 客户端收到了一个或多个Offer报文后。
    *   **动作**: 客户端选择**第一个到达**的Offer（通常是这样），然后再次以**广播**方式发送一个 **DHCP Request** 报文。
    *   **报文关键信息**:
        *   报文中会包含它选择的那个DHCP服务器的标识以及它希望使用的IP地址。
        *   **为什么是广播？** 这是为了通知所有给它发过Offer的服务器：“我已经选定了一个，你们其他的可以收回你们提供的地址了。” 这是一个礼貌的“群发通知”。

*   **A - Acknowledge (确认阶段)**
    *   **触发**: 被客户端选中的DHCP服务器收到了Request报文。
    *   **动作**: 服务器确认该IP地址仍然可用，然后发送一个 **DHCP ACK** (确认) 报文给客户端，正式确认租约。
    *   **报文关键信息**:
        *   这个报文可以是单播也可以是广播，取决于客户端的标志位。
        *   客户端收到ACK后，才算真正配置好了网络参数，可以开始正常通信了。
    *   **例外情况**: 如果服务器发现该IP已被占用，会发送 **DHCP NAK** (否认) 报文，客户端需要重新开始Discover过程。

#### 3. #租期 (Lease Time) 
DHCP分配的IP不是永久的。当租期过半时，客户端会自动向DHCP服务器发送DHCP Request请求续租。如果服务器同意，会回复ACK，租期刷新；如果服务器无响应，客户端会在租期更靠后的时候继续尝试，直到租约过期，IP被释放。

#### 4. 衍生考点
*   #DHCP中继 (DHCP Relay): 如果客户端和DHCP服务器不在同一个广播域（例如，被路由器隔开），广播的Discover报文是过不了路由器的。这时需要在路由器上配置DHCP中继功能，路由器会将客户端的广播请求以**单播**的形式转发给指定的DHCP服务器，从而实现跨网段的地址分配。
*   #DHCP-Snooping : 交换机上的一种安全技术。通过将端口划分为“信任”和“非信任”，只允许来自信任端口（连接合法DHCP服务器的端口）的Offer和ACK报文通过，从而有效防止未经授权的“假冒”DHCP服务器在网络中搞破坏。
*    #自动私有IP寻址APIPA : 当DHCP分配失败时，Windows主机会自动配置一个 `169.254.x.x` 的地址，这有什么作用和限制。