好的，这是对 **IPv4 头部** 的一个完整、详细的描述。

标准的 IPv4 头部固定为 **20字节**，如果包含可选项（Options），则会更长。整个头部结构被设计为 32 位（4 字节）对齐，以便于路由器高效处理。

### IPv4 头部结构图

下面是 IPv4 头部的标准格式图，按 32 位（4 字节）为一行进行排列：

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version|  IHL  |Type of Service|          Total Length         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Identification        |Flags|      Fragment Offset    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Time to Live |    Protocol   |         Header Checksum       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       Source Address                          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Destination Address                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Options                    |    Padding    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

---

### 字段逐一详解

#### 第 1 行 (字节 1-4)

1.  **版本 (Version)**
    *   **长度**: 4 位
    *   **说明**: 定义了 IP 协议的版本。对于 IPv4，这个值**恒为 4** (二进制 `0100`)。

2.  **首部长度 (IHL - Internet Header Length)**
    *   **长度**: 4 位
    *   **说明**: 表示整个 IP 头部的长度，**单位是 4 字节 (32 位)**。
    *   **取值**: 最小值为 5（二进制 `0101`），表示 $5 \times 4 = 20$ 字节，这是一个不含任何选项的最小头部。最大值为 15（二进制 `1111`），表示 $15 \times 4 = 60$ 字节的头部。

3.  **服务类型 (Type of Service - TOS)**
    *   **长度**: 8 位
    *   **说明**: 用于指定数据报的优先级或服务质量（QoS）。例如，视频流可能需要低延迟，而文件传输可能需要高吞吐量。现在这个字段通常被称为 **DSCP** (Differentiated Services Code Point)。

4.  **总长度 (Total Length)**
    *   **长度**: 16 位
    *   **说明**: 表示整个 IP 数据报（头部 + 数据）的总长度，**单位是字节**。
    *   **取值**: 最大值为 $2^{16} - 1 = 65,535$ 字节。但由于底层网络（如以太网）的 MTU 限制，很少能看到这么大的 IP 包。

#### 第 2 行 (字节 5-8) - **IP分片相关**

5.  **标识 (Identification)**
    *   **长度**: 16 位
    *   **说明**: 一个唯一的标识符。当一个 IP 数据报被分片时，所有属于同一个原始数据报的**分片都拥有相同的标识号**。这使得目的主机能够正确地重组它们。

6.  **标志 (Flags)**
    *   **长度**: 3 位
    *   **说明**: 控制分片行为的标志位。
        *   **第 1 位 (保留位)**: 必须为 0。
        *   **第 2 位 (DF - Don't Fragment)**:
            *   `DF = 1`: 表示该数据报**禁止分片**。如果路由器需要分片但看到此位为 1，它会丢弃该包并向源主机发送一个 ICMP "Destination Unreachable (Fragmentation Needed and DF set)" 错误消息。这常用于路径 MTU 发现。
            *   `DF = 0`: 表示允许分片。
        *   **第 3 位 (MF - More Fragments)**:
            *   `MF = 1`: 表示这不是最后一个分片，**后面还有更多分片**。
            *   `MF = 0`: 表示这是**最后一个分片**，或者是唯一的分片（未被分片）。

7.  **分片偏移 (Fragment Offset)**
    *   **长度**: 13 位
    *   **说明**: 指示当前分片的数据部分相对于原始数据报数据部分的起始位置。**单位是 8 字节**。
    *   **注意**: 除了最后一个分片，每个分片的数据长度必须是 8 字节的整数倍。

#### 第 3 行 (字节 9-12)

8.  **生存时间 (TTL - Time to Live)**
    *   **长度**: 8 位
    *   **说明**: 设置了数据报在网络中可以存活的最大“跳数”（即经过的路由器数量）。每经过一个路由器，TTL 值减 1。当 TTL 减到 0 时，路由器会丢弃该数据报，并向源主机发送一个 ICMP "Time Exceeded" 错误消息。这可以**防止数据报在网络中无限循环**。

9.  **协议 (Protocol)**
    *   **长度**: 8 位
    *   **说明**: 指明了 IP 数据报的数据部分承载的是哪种**上层协议**。
    *   **常见值**: `1` 代表 ICMP，`6` 代表 TCP，`17` 代表 UDP。

10. **首部校验和 (Header Checksum)**
    *   **长度**: 16 位
    *   **说明**: 用于校验 **IP 头部**的完整性，确保在传输过程中没有发生错误。**它只校验头部，不校验数据部分**。由于 TTL 字段在每个路由器都会改变，所以**每个路由器都需要重新计算并更新这个校验和**。

#### 第 4 行 (字节 13-16)

11. **源 IP 地址 (Source Address)**
    *   **长度**: 32 位
    *   **说明**: 发送方的 IPv4 地址。

#### 第 5 行 (字节 17-20)

12. **目的 IP 地址 (Destination Address)**
    *   **长度**: 32 位
    *   **说明**: 接收方的 IPv4 地址。

#### 第 6 行及以后 (字节 21-60)

13. **选项 (Options)**
    *   **长度**: 可变，最长 40 字节。
    *   **说明**: 一个可变长度的字段，用于提供一些额外的控制功能，如记录路由、时间戳等。由于处理选项会增加路由器的负担，所以在今天的互联网上很少使用。

14. **填充 (Padding)**
    *   **长度**: 可变。
    *   **说明**: 如果选项字段的长度不是 32 位的整数倍，就需要用 0 来填充，以**确保整个 IP 头部是 32 位对齐的**。

### 总结

这个完整的描述结合了您最初提供的两个片段的优点：
*   它像**第二段描述**一样，严格按照**字节顺序和结构**来组织。
*   它也像**第一段描述**一样，深入解释了每个字段的**功能和动态行为**（如分片和TTL）。

掌握这个完整的结构，您就能非常清晰地理解 IPv4 数据报在网络中的所有行为了。