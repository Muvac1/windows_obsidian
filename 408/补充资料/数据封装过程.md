#数据封装过程 （以 ping 为例）

ping 命令发送一个 ICMP Echo Request 报文的过程完美地展示了这种封装：

1.  **应用层**：用户执行 ping 命令。
2.  **网络层 (ICMP)**：操作系统内核构建一个 #ICMP Echo Request 报文。[[ICMP（互联网控制报文协议）]]
3.  **网络层 (IP)**：内核将此 ICMP 报文作为数据，添加 IP 头部，形成 IP 数据报。IP 头部中的目标地址是 ping 的目标主机地址，协议字段设为1。
    *   封装结构：$IP_{header} [ ICMP_{header} + ICMP_{data} ]$
4.  **数据链路层 (如以太网)**：内核将整个 IP 数据报作为数据，添加以太网头部和尾部（帧校验序列），形成以太网帧。
    *   封装结构：$Ethernet_{header} [ IP_{header} [ ICMP_{header} + ICMP_{data} ] ] Ethernet_{trailer}$
5.  **物理层**：将以太网帧转换为电信号或光信号在网络介质上传输。

提问：一个 HTTP 请求从客户端发送到服务器，数据依次经过的封装是？
*   答案：HTTP 消息 -> TCP 段 -> IP 数据报 -> 以太网帧


 一、数据封装 (Data Encapsulation) - “层层打包”的过程

数据封装描述的是，当你的主机（例如主机2）要发送数据时，数据是如何被一步步“打包”成最终可以在网线上传输的信号的。这个过程是从上到下（从应用层到物理层）的。

让我们以 **主机2 访问 Internet 上的 WWW 服务器** 为例，看看这个“打包”过程：

#### 步骤1：应用层 - 准备“货物”
你打开浏览器想访问一个网站，这就是应用层数据。
*   **数据**: `GET /index.html HTTP/1.1` (一个HTTP请求)

#### 步骤2：传输层 - 第一次包装，贴上“端口号”标签
操作系统将数据交给传输层（比如TCP协议）。TCP会给数据加上一个头部（TCP Header），指明源端口和目的端口。
*   **作用**: 确保数据能被正确地交给服务器上的网页服务程序(通常是80端口)，而不是邮件服务程序。
*   **打包结果**: 这时的数据被称为 **TCP段 (Segment)**。
    *   `[TCP头(源端口, 目的端口=80)] + [原始数据]`

#### 步骤3：网络层 - 第二次包装，贴上“最终地址”运单
TCP段被交给网络层（IP协议）。IP协议会加上一个IP头部（IP Header），包含最终的源IP地址和目的IP地址。
*   **作用**: 这是整个旅程的起点和终点，就像国际快递单上的发件人和收件人地址。**这个地址在整个传输过程中通常是不会改变的**。
*   **打包结果**: 这时的数据被称为 **IP包 (Packet)**。
    *   `[IP头(源IP=主机2_IP, 目的IP=Internet服务器_IP)] + [TCP段]`

#### 步骤4：数据链路层 - 第三次包装，装上“本地运输车”
IP包被交给数据链路层（以太网协议）。以太网协议会加上一个帧头（Ethernet Header）和帧尾（Trailer），包含源MAC地址和目的MAC地址。
*   **关键点**: 这里的目的MAC地址**不是**最终Internet服务器的MAC地址！因为主机2无法直接联系到它。这里的目标是**当前这段路程的下一站**。
*   **思考过程 (关联题目)**:
    1.  主机2判断目的IP（Internet服务器IP）不在本地子网 (`111.123.15.0/24`)。
    2.  因此，它必须把这个IP包交给**默认网关**（路由器 `111.123.15.1`）来处理。
    3.  所以，数据链路层的目标就是把这个包送到网关那里。目的MAC地址就是网关的MAC地址 (`00-a1-a1-a1-a1-a1`)。
*   **打包结果**: 这时的数据被称为 **以太网帧 (Frame)**。
    *   `[以太网头(源MAC=主机2_MAC, 目的MAC=路由器_MAC)] + [IP包] + [以太网尾]`

#### 步骤5：物理层 - 发货
最终，以太网帧被转换成电信号或光信号，通过网线发送出去。

**总结一下封装**：就像套娃一样，数据被一层层地加上头部信息，每一层头部都有其特定的功能。

